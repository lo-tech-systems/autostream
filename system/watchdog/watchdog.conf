###############################################################################
# /etc/watchdog.conf  (Quad-core Raspberry Pi: Zero 2 W / 2 / 3 / 4 / 5)
# This file is part of autostream, Copyright (c) 2025 Lo-tech Systems Limited
###############################################################################

# Hardware watchdog
watchdog-device = /dev/watchdog

# Check cadence
interval = 10

# Reboot if userspace stops kicking the watchdog
watchdog-timeout = 15


###############################################################################
# Make watchdog resilient during heavy load (important during updates)
###############################################################################
# Prevent watchdog from being swapped out under memory pressure / load
realtime = yes
# Optional: give it a modest RT priority (1-99). Keep low to avoid harming the system.
priority = 1


###############################################################################
# CPU / load monitoring thresholds (suggested for quad-core + updates)
#
# Load average is NOT "CPU %". On a 4-core system:
# - load ~4  => fully busy (roughly)
# - load >4  => queueing/backlog
# These thresholds allow spikes during apt upgrades/compiles but still reboot if
# the box is severely overloaded for sustained periods.
###############################################################################
max-load-1  = 12
max-load-5  = 10
max-load-15 = 8


###############################################################################
# Memory check (in PAGES, not MB/GB)
# Conservative: low enough to avoid false reboots during updates, still catches
# severe memory starvation. (0 disables the test.)
###############################################################################
min-memory = 2048


###############################################################################
# Temperature safety
###############################################################################
max-temperature = 80


###############################################################################
# Basic sanity checks
###############################################################################
file = /etc/passwd
file = /etc/shadow


###############################################################################
# Optional "heartbeat file" (useful if you want an external liveness signal)
# If you enable this, something should touch the file at least once per <change>
# seconds, or watchdog will take action.
#
# file   = /run/watchdog-heartbeat
# change = 300
###############################################################################

# Logging (reduce spam)
logtick = 60
