# NGINX Configuration for autostream
# Copyright (c) 2025 Lo-tech Systems Limited. All rights reserved.

# NOTE: The following additions implement a 2-second *client-side* retry
# when the request came from /setup and the upstream returns 502/503/504.
# (Stock nginx cannot sleep 2s and then re-proxy the same request server-side
# without Lua/OpenResty or a third-party module.)

# ---- Depends on this map in http{} scope (outside the server{}), e.g. in nginx.conf ----
# map $http_referer $from_setup {
#     default 0;
#     ~*/setup(?:$|[/?#]) 1;
# }

server {
    listen 80 default_server;
    listen [::]:80 default_server;

    server_name _;

    # Apple icons
    location = /apple-touch-icon.png { alias /opt/autostream/images/apple-touch-icon.png; }
    location = /apple-touch-icon-precomposed.png { alias /opt/autostream/images/apple-touch-icon.png; }
    location = /apple-touch-icon-120x120.png { alias /opt/autostream/images/apple-touch-icon.png; }
    location = /apple-touch-icon-152x152.png { alias /opt/autostream/images/apple-touch-icon.png; }
    location = /apple-touch-icon-167x167.png { alias /opt/autostream/images/apple-touch-icon.png; }
    location = /apple-touch-icon-180x180.png { alias /opt/autostream/images/apple-touch-icon.png; }
    location = /favicon.ico { alias /opt/autostream/images/favicon.ico; }
    location = /favicon-16x16.png { alias /opt/autostream/images/favicon-16x16.png; }
    location = /favicon-32x32.png { alias /opt/autostream/images/favicon-32x32.png; }
    location = /autostream-badge.png { alias /opt/autostream/images/autostream-badge.png; }

    # Default backend (normal operating mode)
    set $html_backend http://127.0.0.1:8080;

    # When /tmp/apmode exists, switch backend to WiFi setup page
    # and cancel any redirect
    if (-f /tmp/apmode) {
        set $html_backend http://127.0.0.1:9080;
    }

    # Intercept upstream failures and show offline page
    proxy_intercept_errors on;

    # UPDATED: route 404/502/503/504 to a named handler that can branch
    error_page 404 502 503 504 = @upstream_failed;

    # UPDATED: choose between normal offline and a retrying page for /setup referers
    location @upstream_failed {
        # If the browser came from /setup, show a retry page that refreshes back
        # to the original URL after ~2 seconds.
        if ($from_setup) {
            return 302 /offline/retrying?next=$scheme://$host$request_uri;
        }

        # Otherwise, show the normal offline page
        return 302 /offline/;
    }

    # -------- Offline pages --------
    location = /offline/ {
        root /opt/autostream/nginx;
        default_type text/html;

        sub_filter_once on;
        sub_filter "__HOSTNAME__" "$hostname";

        add_header Cache-Control "no-store";
        try_files /offline/index.html =500;
    }

    # Retrying page (HTML should meta-refresh to __NEXT__ after 2s)
    location = /offline/retrying {
        root /opt/autostream/nginx;
        default_type text/html;

        add_header Cache-Control "no-store";

        sub_filter_once on;
        sub_filter "__NEXT__" "$arg_next";

        try_files /offline/retrying.html =404;
    }

    location = /offline/rebooting {
        root /opt/autostream/nginx;
        add_header Cache-Control "no-store";
        try_files /offline/rebooting.html =404;
    }

    # -------- CGI endpoints (fcgiwrap) --------
    location = /offline/download-logs {
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME /opt/autostream/nginx/cgi/download-logs.cgi;
        fastcgi_param SCRIPT_NAME /offline/download-logs;
        fastcgi_pass unix:/run/fcgiwrap.socket;
    }

    location = /offline/reboot {
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME /opt/autostream/nginx/cgi/reboot.cgi;
        fastcgi_param SCRIPT_NAME /offline/reboot;
        fastcgi_pass unix:/run/fcgiwrap.socket;
    }

    # -------- autostream_webui endpoints --------
    location / {
        # Timeouts (also apply to hung/slow backend)
        proxy_connect_timeout 10s;
        proxy_send_timeout 5s;
        proxy_read_timeout 5s;

        # proxy_pass $html_backend$request_uri;
        proxy_pass $html_backend$uri$is_args$args;

        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
